(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3792:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>y});var l=r(5155),n=r(2115),a=r(109),s=r(2185),i=r(604),c=r(7082),o=r(4651),h=r(6949),d=r(3585),u=r(4345),x=r(2644),m=r(2173),f=r(8323),p=r(3337),j=r(4863),v=r(1929),g=r.n(v);let w=[{shape:[[1,1,1,1]],color:[0,255,255]},{shape:[[1,1],[1,1]],color:[255,255,0]},{shape:[[0,1,0],[1,1,1]],color:[128,0,128]},{shape:[[0,1,1],[1,1,0]],color:[0,255,0]},{shape:[[1,1,0],[0,1,1]],color:[255,0,0]},{shape:[[1,0,0],[1,1,1]],color:[0,0,255]},{shape:[[0,0,1],[1,1,1]],color:[255,165,0]}];function y(){let e=(0,n.useRef)(null),t=(0,n.useRef)(null),r=(0,n.useRef)(0),[v,y]=(0,n.useState)([]),[b,N]=(0,n.useState)([]),[k,S]=(0,n.useState)(null),[A,E]=(0,n.useState)(!1),[R,T]=(0,n.useState)(!1),[C,M]=(0,n.useState)(!1),[L,F]=(0,n.useState)(0),[D,z]=(0,n.useState)(0),[O,_]=(0,n.useState)(0),[Q,q]=(0,n.useState)(0),[I,W]=(0,n.useState)(0),[B,H]=(0,n.useState)(20),[J,P]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=()=>{P(window.innerWidth<=768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let U=(0,n.useCallback)(()=>{if(!Q||!I)return 20;let e=window.innerWidth;return Math.max(8,Math.floor(Math.min(.8*e/Q,.6*window.innerHeight/I,30)))},[Q,I]);(0,n.useEffect)(()=>{let e,t=()=>{H(U())},r=()=>{clearTimeout(e),e=setTimeout(t,100)};return t(),window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r),clearTimeout(e)}},[U]);let G=(0,n.useCallback)(e=>{let r=document.createElement("canvas"),l=r.getContext("2d",{willReadFrequently:!0});r.width=e.width,r.height=e.height,l.drawImage(e,0,0);let n=l.getImageData(0,0,e.width,e.height);if(!g()(n.data,n.width,n.height)){alert("QRコードが検出できませんでした。別の画像を試してください。"),t.current&&(t.current.value="");return}let a=n.data,s=Math.min(e.width,e.height),i=K(s),c=[],o=[];for(let t=0;t<i;t++){c[t]=[],o[t]=[];for(let r=0;r<i;r++){let l=Math.floor(r*s/i),n=(Math.floor(t*s/i)*e.width+l)*4,h=(a[n]+a[n+1]+a[n+2])/3;c[t][r]=+(h<128),o[t][r]=0}}V(c,o,i),y(c),N(o),q(i),W(i),z(X(c,o)),F(0),E(!0),M(!1),S(null)},[]),K=e=>e<=25?21:e<=30?25:e<=35?29:Math.min(41,Math.max(21,2*Math.floor(e/8)+1)),V=(e,t,r)=>{for(let l=0;l<r;l++)for(let n=0;n<r;n++)(n<9&&l<9||n>=r-8&&l<9||n<9&&l>=r-8)&&(t[l][n]=e[l][n])},X=(e,t)=>{let r=0;for(let l=0;l<e.length;l++)for(let n=0;n<e[l].length;n++)1===e[l][n]&&0===t[l][n]&&r++;return r},Y=(0,n.useCallback)(()=>{let e=w[Math.floor(Math.random()*w.length)];return{x:Math.floor((Q-e.shape[0].length)/2),y:0,shape:JSON.parse(JSON.stringify(e.shape)),color:e.color,width:e.shape[0].length,height:e.shape.length}},[Q]),Z=e=>{let t=[],r=e.shape.length,l=e.shape[0].length;for(let n=0;n<l;n++){t[n]=[];for(let l=0;l<r;l++)t[n][l]=e.shape[r-1-l][n]}return{...e,shape:t,width:t[0].length,height:t.length}},$=(e,t,r)=>{for(let l=0;l<e.height;l++)for(let n=0;n<e.width;n++)if(1===e.shape[l][n]){let e=t+n,a=r+l;if(e<0||e>=Q||a<0||a>=I||b[a]&&0!==b[a][e])return!1}return!0},ee=(0,n.useCallback)(()=>{if(!k)return;let e=[...b.map(e=>[...e])],t=!1;for(let r=0;r<k.height;r++)for(let l=0;l<k.width;l++)if(1===k.shape[r][l]){let n=k.x+l,a=k.y+r;n>=0&&n<Q&&a>=0&&a<I&&1===v[a][n]&&0===b[a][n]&&(e[a][n]=1,F(e=>e+1),t=!0)}t&&N(e),S(Y())},[k,b,v,Q,I,Y]),et=(0,n.useCallback)(()=>{var t;let r=[];for(let e=0;e<I;e++)r[e]=Array(Q).fill(0);V(v,r,Q),N(r),F(0),S(Y()),M(!1),T(!1),_(0);let l=document.querySelector(".popup");l&&l.remove(),null==(t=e.current)||t.focus()},[v,Q,I,Y]),er=e=>{if(k&&!C)switch(e){case"left":$(k,k.x-1,k.y)&&S(e=>e?{...e,x:e.x-1}:null);break;case"right":$(k,k.x+1,k.y)&&S(e=>e?{...e,x:e.x+1}:null);break;case"down":$(k,k.x,k.y+1)&&S(e=>e?{...e,y:e.y+1}:null);break;case"rotate":let t=Z(k);$(t,t.x,t.y)&&S(t);break;case"place":ee();break;case"pause":T(!0);break;case"restart":T(!1)}};(0,n.useEffect)(()=>{let e=e=>{if(k&&!C)switch(e.code){case"ArrowLeft":$(k,k.x-1,k.y)&&S(e=>e?{...e,x:e.x-1}:null);break;case"ArrowRight":$(k,k.x+1,k.y)&&S(e=>e?{...e,x:e.x+1}:null);break;case"ArrowDown":$(k,k.x,k.y+1)&&S(e=>e?{...e,y:e.y+1}:null);break;case"ArrowUp":let t=Z(k);$(t,t.x,t.y)&&S(t);break;case"Enter":ee();break;case"Space":e.preventDefault(),T(!R)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[k,R,C,ee]),(0,n.useEffect)(()=>{if(!A||C||!k||R){r.current&&cancelAnimationFrame(r.current);return}let e=()=>{_(e=>{if(e>=60)if($(k,k.x,k.y+1))return S(e=>e?{...e,y:e.y+1}:null),0;else return ee(),0;return e+1}),r.current=requestAnimationFrame(e)};return r.current=requestAnimationFrame(e),()=>{r.current&&cancelAnimationFrame(r.current)}},[A,C,k,R,ee,60]),(0,n.useEffect)(()=>{if(!A||!e.current)return;let t=e.current,r=t.getContext("2d");t.width=Q*B,t.height=I*B,(()=>{r.clearRect(0,0,t.width,t.height),r.fillStyle="#f0f0f0",r.fillRect(0,0,t.width,t.height);for(let e=0;e<I;e++)for(let t=0;t<Q;t++){let l=t*B,n=e*B;1===b[e][t]?(r.fillStyle="#000000",r.fillRect(l,n,B,B),r.strokeStyle="#666666"):(1===v[e][t]?r.fillStyle="rgba(200, 200, 255, 0.4)":r.fillStyle="#ffffff",r.fillRect(l,n,B,B),r.strokeStyle="#cccccc"),r.strokeRect(l,n,B,B)}if(k){r.fillStyle="rgba(".concat(k.color[0],", ").concat(k.color[1],", ").concat(k.color[2],", 0.8)"),r.strokeStyle="#000000";for(let e=0;e<k.height;e++)for(let t=0;t<k.width;t++)if(1===k.shape[e][t]){let l=(k.x+t)*B,n=(k.y+e)*B;r.fillRect(l,n,B,B),r.strokeRect(l,n,B,B)}}})()},[A,b,k,v,Q,I,B]),(0,n.useEffect)(()=>{A&&!k&&Q>0&&S(Y())},[A,k,Q,Y]),(0,n.useEffect)(()=>{if(C||!A)return;let e=!0;for(let t=0;t<I;t++){for(let r=0;r<Q;r++)if(1===v[t][r]&&1!==b[t][r]){e=!1;break}if(!e)break}if(e){M(!0);let e=document.createElement("div");e.className="popup",e.innerHTML="\uD83C\uDF89 COMPLETE! \uD83C\uDF89<br><br>QRコード完成おめでとう！",document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}},[b,v,C,A,I,Q]);let el=e=>{if(!e.type.startsWith("image/"))return void alert("画像ファイルを選択してください。");let t=new FileReader;t.onload=e=>{var t;let r=new Image;r.onload=()=>G(r),r.src=null==(t=e.target)?void 0:t.result},t.readAsDataURL(e)},en=D>0?Math.round(L/D*100):0;return(0,l.jsxs)("div",{className:"container",children:[(0,l.jsx)("h1",{className:"title",children:"QRコードテトリス"}),(0,l.jsxs)("p",{className:"subtitle",children:["QRコードをアップロードして、",(0,l.jsx)("br",{}),"ブロックを積み重ねて元の画像を完成させよう！"]}),!A&&(0,l.jsxs)("div",{className:"upload-area",onDrop:e=>{e.preventDefault();let t=e.dataTransfer.files[0];t&&el(t)},onDragOver:e=>e.preventDefault(),onClick:()=>{var e;return null==(e=t.current)?void 0:e.click()},children:[(0,l.jsxs)("p",{style:{fontSize:"1.3rem",marginBottom:"20px"},children:[(0,l.jsx)(i.A,{})," QRコードの画像をここにドラッグ＆ドロップ"]}),(0,l.jsx)("p",{style:{marginBottom:"20px"},children:"または"}),(0,l.jsxs)("button",{className:"upload-btn",children:[(0,l.jsx)(p.A,{})," ファイルを選択"]}),(0,l.jsx)("input",{ref:t,type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{var t;let r=null==(t=e.target.files)?void 0:t[0];r&&el(r)}})]}),A&&(0,l.jsxs)("div",{className:"game-container",children:[(0,l.jsx)("div",{className:"game-area",children:(0,l.jsx)("canvas",{ref:e,tabIndex:-1})}),(0,l.jsxs)("div",{className:"controls",children:[!J&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{children:"操作方法"}),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"左右移動"}),(0,l.jsx)("span",{children:"← →"})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"回転"}),(0,l.jsx)("span",{children:"↑"})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"高速落下"}),(0,l.jsx)("span",{children:"↓"})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"配置決定"}),(0,l.jsx)("span",{children:"Enter"})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"一時停止"}),(0,l.jsx)("span",{children:"Space"})]})]}),(0,l.jsx)("button",{className:"upload-btn place-btn",onClick:ee,children:"配置決定"}),(0,l.jsx)("button",{className:"reset-btn",onClick:et,children:"リセット"})]}),(0,l.jsxs)("div",{style:{marginTop:"20px",padding:"15px",background:"rgba(255,255,255,0.1)",borderRadius:"10px"},children:[(0,l.jsxs)("h4",{style:{marginTop:0,color:"var(--secondary)"},children:[(0,l.jsx)(f.A,{})," 統計"]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"配置済み"}),(0,l.jsx)("span",{children:L})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"残り"}),(0,l.jsx)("span",{children:D-L})]}),(0,l.jsxs)("div",{className:"control-item",children:[(0,l.jsx)("span",{children:"進捗"}),(0,l.jsxs)("span",{children:[en,"%"]})]})]})]}),J&&(0,l.jsx)("div",{className:"mobile-controls",children:(0,l.jsxs)("div",{className:"controller",children:[(0,l.jsxs)("div",{className:"d-pad",children:[(0,l.jsx)(a.A,{className:"control-btn up",variant:"contained",color:"primary",onTouchStart:()=>er("rotate"),children:(0,l.jsx)(d.A,{})}),(0,l.jsxs)("div",{className:"horizontal",children:[(0,l.jsx)(a.A,{className:"control-btn left",variant:"contained",color:"primary",onTouchStart:()=>er("left"),children:(0,l.jsx)(c.A,{})}),(0,l.jsx)(a.A,{className:"control-btn down",variant:"contained",color:"primary",onTouchStart:()=>er("down"),children:(0,l.jsx)(h.A,{})}),(0,l.jsx)(a.A,{className:"control-btn right",variant:"contained",color:"primary",onTouchStart:()=>er("right"),children:(0,l.jsx)(o.A,{})})]})]}),(0,l.jsxs)("div",{className:"action-buttons",children:[(0,l.jsxs)(a.A,{className:"control-btn place",variant:"contained",color:"primary",onTouchStart:()=>er("place"),children:[(0,l.jsx)(s.A,{component:"span",sx:{mr:.5},children:(0,l.jsx)(u.A,{})})," 配置"]}),(0,l.jsxs)(a.A,{className:"control-btn reset",variant:"contained",color:"primary",onTouchStart:et,children:[(0,l.jsx)(s.A,{component:"span",sx:{mr:.5},children:(0,l.jsx)(j.A,{})})," リセット"]}),(0,l.jsx)(a.A,{className:"control-btn pause",variant:"contained",color:"primary",onTouchStart:()=>er(R?"restart":"pause"),children:R?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.A,{component:"span",sx:{mr:.5},children:(0,l.jsx)(m.A,{})}),"再開"]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.A,{component:"span",sx:{mr:.5},children:(0,l.jsx)(x.A,{})}),"一時停止"]})})]})]})})]})]})}},9096:(e,t,r)=>{Promise.resolve().then(r.bind(r,3792))}},e=>{e.O(0,[153,756,441,964,358],()=>e(e.s=9096)),_N_E=e.O()}]);